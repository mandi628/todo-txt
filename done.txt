#!/bin/bash source-this-script
[ "$BASH_VERSION" ] || return

_todo()
{
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    local -r OPTS="-@ -@@ -+ -++ -d -f -h -p -P -PP -a -n -t -v -vv -V -x"
    local -r COMMANDS="\
        add a addto addm append app archive command del  \
        rm depri dp do help list ls listaddons listall lsa listcon  \
        lsc listfile lf listpri lsp listproj lsprj move \
        mv prepend prep pri p replace report shorthelp"
    local -r MOVE_COMMAND_PATTERN='move|mv'

    local _todo_sh=${_todo_sh:-todo.sh}
    local completions
    if [ $COMP_CWORD -eq 1 ]; then
        completions="$COMMANDS $(eval TODOTXT_VERBOSE=0 $_todo_sh command listaddons 2>/dev/null) $OPTS"
    elif [[ $COMP_CWORD -gt 2 && ( \
        "${COMP_WORDS[COMP_CWORD-2]}" =~ ^($MOVE_COMMAND_PATTERN${_todo_file2_actions:+|${_todo_file2_actions}})$ || \
        "${COMP_WORDS[COMP_CWORD-3]}" =~ ^($MOVE_COMMAND_PATTERN${_todo_file3_actions:+|${_todo_file3_actions}})$ ) ]]; then
        # "move ITEM# DEST [SRC]" has file arguments on positions 2 and 3.
        completions=$(eval TODOTXT_VERBOSE=0 $_todo_sh command listfile 2>/dev/null)
    else
        case "$prev" in
            command)
                completions=$COMMANDS;;
            help)
                completions="$COMMANDS $(eval TODOTXT_VERBOSE=0 $_todo_sh command listaddons 2>/dev/null)";;
            -*) completions="$COMMANDS $(eval TODOTXT_VERBOSE=0 $_todo_sh command listaddons 2>/dev/null) $OPTS";;
            *)  if [[ "$prev" =~ ^(addto|listfile|lf${_todo_file1_actions:+|${_todo_file1_actions}})$ ]]; then
                    completions=$(eval TODOTXT_VERBOSE=0 $_todo_sh command listfile 2>/dev/null)
                else
                    case "$cur" in
                        +*) completions=$(eval TODOTXT_VERBOSE=0 $_todo_sh command listproj 2>/dev/null)
                            COMPREPLY=( $( compgen -W "$completions" -- $cur ))
                            [ ${#COMPREPLY[@]} -gt 0 ] && return 0
                            # Fall back to projects extracted from done tasks.
                            completions=$(eval 'TODOTXT_VERBOSE=0 TODOTXT_SOURCEVAR=\$DONE_FILE' $_todo_sh command listproj 2>/dev/null)
                            ;;
                        @*) completions=$(eval TODOTXT_VERBOSE=0 $_todo_sh command listcon 2>/dev/null)
                            COMPREPLY=( $( compgen -W "$completions" -- $cur ))
                            [ ${#COMPREPLY[@]} -gt 0 ] && return 0
                            # Fall back to contexts extracted from done tasks.
                            completions=$(eval 'TODOTXT_VERBOSE=0 TODOTXT_SOURCEVAR=\$DONE_FILE' $_todo_sh command listcon 2>/dev/null)
                            ;;
                        *)  if [[ "$cur" =~ ^[0-9]+$ ]]; then
                                declare -a sedTransformations=(
                                    # Remove the (padded) task number; we prepend the
                                    # user-provided $cur instead.
                                    -e 's/^ *[0-9]\{1,\} //'
                                    # Remove the timestamp prepended by the -t option,
                                    # but keep any priority (as it's short and may
                                    # provide useful context).
                                    -e 's/^\((.) \)\{0,1\}[0-9]\{2,4\}-[0-9]\{2\}-[0-9]\{2\} /\1/'
                                    # Remove the done date and (if there) the timestamp.
                                    # Keep the "x" (as it's short and may provide useful
                                    # context)
                                    -e 's/^\([xX] \)\([0-9]\{2,4\}-[0-9]\{2\}-[0-9]\{2\} \)\{1,2\}/\1/'
                                    # Remove any trailing whitespace; the Bash
                                    # completion inserts a trailing space itself.
                                    -e 's/[[:space:]]*$//'
                                    # Finally, limit the output to a single line just as
                                    # a safety check of the ls action output.
                                    -e '1q'
                                )
                                local todo=$( \
                                    eval TODOTXT_VERBOSE=0 $_todo_sh '-@ -+ -p -x command ls "^ *${cur} "' 2>/dev/null | \
                                    sed "${sedTransformations[@]}" \
                                )
                                # Append task text as a shell comment. This
                                # completion can be a safety check before a
                                # destructive todo.txt operation.
                                [ "$todo" ] && COMPREPLY[0]="$cur # $todo"
                                return 0
                            else
                                return 0
                            fi
                            ;;
                    esac
                fi
                ;;
        esac
    fi

    COMPREPLY=( $( compgen -W "$completions" -- $cur ))
    return 0
}
complete -F _todo todo.sh

# If you define an alias (e.g. "t") to todo.sh, you need to explicitly enable
# completion for it, too:
#complete -F _todo t
# It is recommended to put this line next to your alias definition in your
# ~/.bashrc (or wherever else you're defining your alias). If you simply
# uncomment it here, you will need to redo this on every todo.txt update!

# If you have renamed the todo.sh executable, or if it is not accessible through
# PATH, you need to add and use a wrapper completion function, like this:
#_todoElsewhere()
#{
#    local _todo_sh='/path/to/todo2.sh'
#    _todo "$@"
#}
#complete -F _todoElsewhere /path/to/todo2.sh

# If you use aliases to use different configuration(s), you need to add and use
# a wrapper completion function for each configuration if you want to complete
# from the actual configured task locations:
#alias todo2='todo.sh -d "$HOME/todo2.cfg"'
#_todo2()
#{
#    local _todo_sh='todo.sh -d "$HOME/todo2.cfg"'
#    _todo "$@"
#}
#complete -F _todo2 todo2
x 2024-07-14 Aldi for dinner groceries @errands due:2024-07-14
x 2024-07-14 church gig +money @UpstateSuzuki due:2024-07-14
x 2024-07-15 Family Meeting 2000 +family @home due:2024-07-14
x 2024-07-15 make soap hammock for shower +crochet @AumannStudios due:2024-07-14
x 2024-07-15 moms nails @errands +family due:2024-07-14
x 2024-07-15 take trash to street +cleanhouse @home due:2024-07-14
x 2024-07-15 get toilet paper +cleanhouse @home due:2024-07-15 @Tess
x 2024-07-15 Tess dentist 1050 +family @kids due:2024-07-15
x 2024-07-15 deposit church money +money @UpstateSuzuki due:2024-07-15
x 2024-07-15 text Alec and Lena about party Sunday +family @phone due:2024-07-15
x 2024-07-15 schedule plasma donations +money due:2024-07-14
x 2024-07-15 Suzi work Sallys 945-3 +family +work @kids due:2024-07-15
x 2024-07-15 Micky work 9-5 +family @kids due:2024-07-15
x 2024-07-15 daily dishes +cleanhouse @home due:2024-07-15
x 2024-07-15 clean studio +cleanhouse @home due:2024-07-15 @Monday
x 2024-07-15 practice guitar +lessons @UpstateSuzuki due:2024-07-15
x 2024-07-15 Ram viola lesson 1600 +lessons @UpstateSuzuki due:2024-07-15
x 2024-07-15 Unit 4: Repeatable Tasks +GetProgramming @chromebook due:2024-07-13 +Python
x 2024-07-15 have Tess confirm guests +suzis-party @Tess due:2024-07-20
x 2024-07-15 check Westlake account for last payment +money @Micky due:2024-07-15 +bills
x 2024-07-15 Tess dinner Taco Mac Salad +family +menu @kids due:2024-07-15
x 2024-07-15 scoop catboxes +cleanhouse @home due:2024-07-15 @pm-rtn

x 2024-07-15 Suzi spray wasps +cleanhouse @home @Suzi due:2024-07-15

x 2024-07-15 journal in notebook @personal due:2024-07-15 @pm-rtn
x 2024-07-16 knit blue-brown-tan socks +knitting @AumannStudios
x 2024-07-23 Verizon payment out due:2024-07-20
x 2024-07-23 get rid of desk in eating room +cleanhouse @home due:2024-07-26
x 2024-07-23 Tuesday plasma donation 0800 +money due:2024-07-23
x 2024-07-23 text Shannon re-Annabelle +lessons @UpstateSuzuki @phone due:2024-07-20
x 2024-07-23 text Sethu to schedule Rams lesson +money @UpstateSuzuki @phone due:2024-07-18
x 2024-07-23 Tess work PJ 4-9 +family +work @kids due:2024-07-21
x 2024-07-23 Tess work PJ 4-9 +family +work @kids due:2024-07-20
x 2024-07-23 Tess work CocoBon 11-4 +family +work @kids due:2024-07-20
x 2024-07-23 Tess work CocoBon 11-4 +family +work @kids due:2024-07-19
x 2024-07-23 take trash to street +cleanhouse @home due:2024-07-21
x 2024-07-23 Suzi work Sollys 930-130 +family +work @kids due:2024-07-19
x 2024-07-23 Suzi work CB-S 130-800 +family +work @kids due:2024-07-20
x 2024-07-23 Suzi hang with Isabella +family @kids due:2024-07-18
x 2024-07-23 Suzi brunch date +family @kids due:2024-07-18
x 2024-07-23 Suzi and Tess YOYO dinner +family +menu @kids due:2024-07-18
x 2024-07-23 Suzi and Bumpa cake party +family @errands due:2024-07-21
x 2024-07-23 start washing laundry +cleanhouse @home @am-rtn due:2024-07-19 @Friday
x 2024-07-23 start washing laundry +cleanhouse @home @am-rtn @Saturday due:2024-07-20
x 2024-07-23 start washing laundry +cleanhouse @home @am-rtn @Monday due:2024-07-22
x 2024-07-23 schedule plasma donations +money due:2024-07-21 @phone
x 2024-07-23 Ruby guitar lesson 1400 +lessons @UpstateSuzuki due:2024-07-18
x 2024-07-23 put away clean laundry +cleanhouse @home @pm-rtn @Saturday due:2024-07-20
x 2024-07-23 put away clean laundry +cleanhouse @home @pm-rtn @Monday due:2024-07-22
x 2024-07-23 put away clean laundry +cleanhouse @home @pm-rtn @Friday due:2024-07-19
x 2024-07-23 Noah violin lesson 1000 +lessons @UpstateSuzuki due:2024-07-20
x 2024-07-23 Micky work at home 11-3 +family +work @kids due:2024-07-19
x 2024-07-23 Micky work 11-7 +family +work @kids due:2024-07-18
x 2024-07-23 Micky dinner Grilled Cheese and soup +family +menu @kids due:2024-07-19
x 2024-07-23 Micky and Ash date night +family @kids due:2024-07-18
x 2024-07-23 Luke and Eirene violin lesson 1430 +lessons @UpstateSuzuki due:2024-07-18
x 2024-07-23 Friday plasma donation 0845 due:2024-07-19 +money
x 2024-07-23 find Skyes flash drive +money @UpstateSuzuki due:2024-07-18
x 2024-07-23 Family Meeting 2000 +family @home due:2024-07-21
x 2024-07-23 Dinner - Personal Pizzas +family +menu @kids due:2024-07-21
x 2024-07-23 Dinner - Nachoes +family +menu @kids due:2024-07-20
x 2024-07-23 Christ Reformed Church gig 1000 +money @UpstateSuzuki due:2024-07-21
x 2024-07-23 Beatrix and LucyJean violin lesson 1600 +lessons @UpstateSuzuki due:2024-07-18
x 2024-07-23 Tess work PJ 4-9 +family +work @kids due:2024-07-17
x 2024-07-23 Suzi work CB-A 930-530 +work +family @kids due:2024-07-17
x 2024-07-23 Micky work 11-7 +family +work @kids due:2024-07-17
x 2024-07-23 Judah viola lesson 1400 +lessons @UpstateSuzuki due:2024-07-17
x 2024-07-23 Ash dinner Stuffed Shells +family +menu @kids due:2024-07-17
x 2024-07-23 wash daily dishes +cleanhouse @home due:2024-07-16 @pm-rtn
x 2024-07-23 Unit 5: Organizing Your Code +Python @chromebook due:2024-07-15
x 2024-07-23 Tuesday plasma donation 0800 due:2024-07-16 +money
x 2024-07-23 Tess work CocoBon 10-4 +family +work @kids due:2024-07-16
x 2024-07-23 Suzi work CB-S 930-4 +family +work @kids due:2024-07-16
x 2024-07-23 Suzi dinner Honey Soy Salmon +family +menu @kids due:2024-07-16
x 2024-07-23 scoop catboxes +cleanhouse @home @pm-rtn due:2024-07-16
x 2024-07-23 put away clean laundry +cleanhouse @home @pm-rtn due:2024-07-15
x 2024-07-23 move money from Grifols to WF +money @errands due:2024-07-16
x 2024-07-23 Micky work 11-7 +family +work @kids due:2024-07-16
x 2024-07-23 clean kitchen and eating room +cleanhouse @home due:2024-07-16
x 2024-07-30 put away clean dishes +cleanhouse @home due:2024-07-16 @am-rtn
x 2024-07-30 text Eden about wool +spinning @AumannStudios due:2024-07-20 +CapeCharles
x 2024-07-30 pay car insurance 232 +bills +money @home due:2024-07-16
x 2024-07-30 Get Programming Lesson 24 +Python @computer due:2024-07-30
x 2024-07-30 Get Programming Lesson 25 +Python @computer due:2024-07-30
x 2024-07-30 reply to Jen re- viola for Kathleen @phone @UpstateSuzuki due:2024-07-30
x 2024-07-30 Get Programming Lesson 26 +Python @computer due:2024-07-30
x 2024-07-30 buy decorations for party +suzis-party @errands due:2024-07-26
x 2024-07-30 buy food for party +suzis-party @errands due:2024-07-26
x 2024-07-30 buy party favors for party +suzis-party @errands due:2024-07-26
x 2024-07-30 follow up with maybes +suzis-party @Tess due:2024-07-22
x 2024-07-30 Friday plasma donation 0845 +money due:2024-07-26
x 2024-07-30 moms nails @errands +family due:2024-07-28
x 2024-07-30 return library books @errands due:2024-07-26
x 2024-07-30 clean kitchen/eating room +cleanhouse @home @Tuesday due:2024-07-30
